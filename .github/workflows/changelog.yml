name: Generate Changelog
permissions:
  contents: write
  pull-requests: write
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  changelog:
    name: Update CHANGELOG.md
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # komplette History für git log

      - name: Generate changelog section from git log
        run: |
          set -euo pipefail

          # Version aus VERSION-Datei lesen
          if [ -f VERSION ]; then
            VERSION="$(cat VERSION)"
          else
            echo "VERSION-Datei nicht gefunden, breche ab."
            exit 1
          fi

          TAG_HEADER="v${VERSION}"
          echo "Current VERSION: ${VERSION} (Header: ${TAG_HEADER})"

          # Letztes Tag ermitteln (letztes Release)
          LAST_TAG="$(git describe --tags --abbrev=0 2>/dev/null || true)"

          if [ -n "${LAST_TAG}" ]; then
            echo "Last tag: ${LAST_TAG}"
            RANGE="${LAST_TAG}..HEAD"
          else
            echo "No previous tag found. Using full history."
            RANGE="HEAD"
          fi

          DATE="$(date +%F)"

          # Neue Sektion in temporäre Datei schreiben
          SECTION_FILE="SECTION.md"
          {
            echo "## ${TAG_HEADER} - ${DATE}"
            echo

            # Commits auflisten, dabei Changelog-/Merge-Spam rausfiltern
            git log --pretty='%s (%h)' ${RANGE} \
              | grep -v -E '^Update CHANGELOG\.md' \
              | grep -v -E '^Merge branch ' \
              | sed 's/^/- /'

            echo
          } > "${SECTION_FILE}"

          # Wenn es noch kein CHANGELOG gibt: neu erstellen
          if [ ! -f CHANGELOG.md ]; then
            {
              echo "# Changelog"
              echo
              cat "${SECTION_FILE}"
            } > CHANGELOG.md
            exit 0
          fi

          # Bestehendes CHANGELOG bereinigen:
          # - alte Kopfzeile "# Changelog" entfernen (wir setzen sie neu)
          # - alten Block für aktuelle Version komplett entfernen
          CLEANED_OLD="OLD_SECTIONS.md"
          awk -v ver="## ${TAG_HEADER} " '
            BEGIN { skip=0 }
            {
              # alte Kopfzeile verwerfen
              if (NR == 1 && $0 ~ /^# Changelog/) { next }

              # Versions-Überschriften erkennen
              if ($0 ~ /^## /) {
                if (index($0, ver) == 1) {
                  # ab hier alten Block für aktuelle Version überspringen
                  skip=1
                  next
                } else if (skip == 1) {
                  # neue Version beginnt, ab hier wieder drucken
                  skip=0
                }
              }

              if (skip == 0) {
                print
              }
            }
          ' CHANGELOG.md > "${CLEANED_OLD}"

          # Neues CHANGELOG aufbauen:
          # - Kopfzeile
          # - neue Sektion
          # - Rest (bereinigte alten Versionen)
          {
            echo "# Changelog"
            echo
            cat "${SECTION_FILE}"
            cat "${CLEANED_OLD}"
          } > CHANGELOG.md

      - name: Commit CHANGELOG.md
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update CHANGELOG.md for v${{ github.sha }}"
          file_pattern: CHANGELOG.md
          branch: main
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"